# Table capacity fundamentals
Amazon DynamoDB 的表容量（Table Capacity）是其性能和成本管理的核心组成部分。DynamoDB 提供了两种容量模式：按需（On-Demand）和预留（Provisioned）。以下是对这两种容量类型的详细讲解，以及相关的基本原理。

### 1. 容量模式

#### a. 预留容量（Provisioned Capacity）

- **定义**：
  - 在预留容量模式下，您可以为每个表指定每秒的读写容量单位（RU / WU）。这意味着您需要预先定义您的表在任何给定时间所需的读写能力。

- **读写单元（Read Capacity Units / Write Capacity Units）**：
  - **读容量单位（RCU）**：
    - 1 个 RCU 可以支持每秒一次强一致性读取 1 KB 数据，或者每秒两次最终一致性读取 1 KB 数据。
  - **写容量单位（WCU）**：
    - 1 个 WCU 可以支持每秒写入 1 KB 数据。

- **成本**：
  - 预留容量的定价基于您为表配置的读写容量。在实际使用中，如果超出预留的容量，则会遭遇耗尽并可能会受到限制。

- **自动扩展**：
  - DynamoDB 提供了自动扩展功能，可以根据实际使用情况动态调整预留容量，以防止超出限制。

#### b. 按需容量（On-Demand Capacity）

- **定义**：
  - 按需模式允许您在不预定义读写能力的情况下处理突发的流量。这意味着 DynamoDB 会自动管理容量，您仅在使用时付费。

- **适用场景**：
  - 按需模式适合负载波动较大的应用，或不知道确切用量的情况，例如启动新应用程序时。

- **成本**：
  - 按需模式的定价基于您执行的读取和写入请求数量。没有预留容量的前期成本，可以大大简化使用模型。

### 2. 如何选择容量模式

选择合适的容量模式取决于多个因素：

- **负载特征**：
  - 如果负载相对稳定，且您能够预估读写需求，预留容量可能更具成本效益。
  - 如果负载波动较大，或您不确定需求，按需模式可能更合适。

- **成本控制**：
  - 监控和优化预留容量设置可以帮助您降低成本。
  - 按需模式的支付仅基于使用，但其成本可能在高流量期间增加。

### 3. 监控与优化

- **使用 CloudWatch**：
  - DynamoDB 集成了 Amazon CloudWatch 用于监控表的性能和容量使用情况。您可以设置警报以监控读/写容量和流量模式。
  
- **扩展与收缩**：
  - 对于预留容量，确保定期评估和调整容量设置，避免冗余或有限资源造成的性能瓶颈。

### 4. 其他相关概念

- **数据一致性**：
  - 在对表的读取操作中，您可以选择强一致性或最终一致性。强一致性会使用更多的读容量单元。

- **事务性操作**：
  - 如果使用 DynamoDB 的事务功能（如 `TransactWriteItems`），会消耗额外的写容量单元。

### 总结

DynamoDB 的表容量管理是确保高性能和控制成本的关键因素。根据应用的使用模式选择适当的容量模式，通过监控和调整，可以有效管理 DynamoDB 的性能和费用。选择预留或按需模式时，需要根据应用的负载特性以及成本管理目标进行综合考虑。

## partition throughput
Amazon DynamoDB 的分区吞吐量（Partition Throughput）是理解和优化 DynamoDB 性能的关键概念。分区是 DynamoDB 数据存储和访问模型的基本单位。以下是有关 DynamoDB 分区吞吐量的详细说明，包括其工作原理、资源管理、性能优化等方面。

### 1. 分区的基本概念

#### a. 什么是分区？

- **定义**：
  - 在 DynamoDB 中，数据在物理上被划分为多个分区，每个分区用于存储一部分数据。每个分区都有其独立的读取和写入能力。

- **主键与分区**：
  - DynamoDB 使用主键（分区键和排序键）来将数据分布到不同的分区。相同分区键的数据将存储在同一个分区中，从而影响读写性能。

#### b. 分区键的作用

- **分布数据**：
  - 分区键的选择可以影响数据在不同分区中的分布。如果某个分区键的值不均匀，将导致数据和吞吐量的热点，影响性能。

### 2. 吞吐量单位

#### a. 读容量单位（RCU）

- **定义**：
  - 1 个读容量单位可以支持每秒对 1 KB 数据的强一致性读取，或对 2 KB 数据的最终一致性读取。

#### b. 写容量单位（WCU）

- **定义**：
  - 1 个写容量单位可以支持每秒写入 1 KB 的数据。

### 3. 分区吞吐量的管理

#### a. 预留容量

- **定义**：
  - 在预留容量模式下，您可以为每个表定义其总吞吐量，并将该吞吐量均匀分布到多个分区。

- **分区限制**：
  - 每个分区在任何时间只能支持高达一定数量的 RCU 和 WCU，通常为 3,000 RCU 和 1,000 WCU（具体的限制会根据您的 AWS 账户和区域而异）。

#### b. 按需模式

- **动态扩展**：
  - 在按需模式下，DynamoDB 自动管理并分配分区，以应对应用程序的变化负载。这种情况不需要用户手动管理分区，但是使用成本可能会增加。

### 4. 性能优化

#### a. 选择适当的主键

- **均匀分布**：
  - 选择用于主键的值来确保负载均匀分布，可以减少热点分区。常见的做法是使用散列键和复合键。

#### b. 监控和调整

- **使用 CloudWatch**：
  - DynamoDB 与 Amazon CloudWatch 集成，允许用户监控分区的读取和写入吞吐量，并检测潜在的热点问题。

- **自动扩展**：
  - 对于预留容量，启用自动扩展来根据使用情况自动管理容量。

### 5. 处理热点问题

#### a. 热点分区

- **什么是热点？**
  - 热点是指在某个分区上出现较高的流量负载，通常会导致性能下降和请求失败。热点通常发生在使用不均匀的分区键时。

#### b. 解决方案

- **添加散列键**：
  - 在分区键的设计上添加额外的变化（如时间戳或随机值），使数据分布更加均匀。
- **分离表**：
  - 将高流量的操作分离到不同的表中以减少单个表的负载。

是的，您所提到的这些方面正是理解 Amazon DynamoDB 分区管理和性能的核心。以下是对您提到的内容的详细解释及补充：

### 6. 分区容量限制
![img_3.png](..%2Fimg%2Fimg_3.png)
---
#### a. 存储限制

- **每个分区存储上限**：
    - 每个分区最多可以存储 10 GB 的表数据。这一限制意味着在设计表时，您需要考虑到数据如何分布在多个分区中，以避免达到单个分区的存储极限。

#### b. I/O 操作限制

- **读写操作的限制**：
    - 每个分区对读取和写入操作有上限。这确保了一个分区不会占用全部资源，从而影响其他分区的性能。
    - 具体的限制取决于使用的容量模式：
        - 在 **预留容量模式** 中，您为每个表设置的 RCU 和 WCU 必须合理地分布在多个分区中。
        - 在 **按需模式** 中，DynamoDB 会自动管理这些操作。

### 7. 分区的动态管理

#### a. 节点和分区的关系

- **节点（Node）**：
    - DynamoDB 是基于分布式计算设计的，底层是由多个节点组成的集群。每个节点可以拥有多个分区，节点的存储和 I/O 能力决定了它可以承载的分区数量。

#### b. 自动分区管理

- **自动化管理**：
    - DynamoDB 的设计旨在最大限度地减少用户在分区管理上的负担。AWS 定期监控使用情况，并根据需要动态添加或删除分区，确保性能优化。
    - 这种自动化管理意味着用户无需手动干预，DynamoDB 会根据应用的负载和流量模式调整资源。

### 8. 用户体验

#### a. 用户隐私

- **简化操作**：
    - 用户不需要关心具体的分区数量、节点容量或底层硬件的细节。这使得开发人员可以更加专注于应用程序的开发和性能优化，而无需管理数据存储和分区等复杂问题。

#### b. 強大的性能调优

- **性能优化**：
    - 通过使用 Amazon CloudWatch，用户可以监控表的性能，查看分区的读取和写入请求情况。这种监控工具提供了透明度，可以及时发现潜在的性能问题。

# Charge for the table & optional feature

在 Amazon DynamoDB 中，费用主要根据存储、读写操作以及选项功能的使用情况来计算。以下是对这些费用的详细说明：

### 1. 存储费用 (charged for amount of storage)

- **按存储量计费**：
  - DynamoDB 按照您所使用的存储量（以 GB 为单位）收取费用。存储费用覆盖所有表中的实体、索引、备份和快照。
  - 例如，如果您创建了一张表，并且表的数据总量为 20 GB，那么您将为这 20 GB 的存储付费。

- **费用计算**：
  - 存储费用通常是基于每月使用的总容量。例如，每 GB 每月的价格为 X 美元，那么 20 GB 的存储费用为 20 * X 美元。

### 2. 读写操作费用 (charged for number of READ & WRITE)

#### a. 读取操作费用

- **读容量单位（RCU）**：
  - 在预留容量模式下，您为表设置了读取容量单位，DynamoDB 会根据您使用的 RCU 进行计费。每个 RCU 支持每秒对 1 KB 数据的强一致性读取，或每秒对 2 KB 数据的最终一致性读取。
  - 在按需模式下，您将按实际读取请求数量计费。

#### b. 写入操作费用

- **写容量单位（WCU）**：
  - 在预留容量模式下，您为表设置了写入容量单位，DynamoDB 会根据您使用的 WCU 进行计费。每个 WCU 支持每秒写入 1 KB 的数据。
  - 在按需模式下，您将按实际写入请求数量计费。

### 3. 选项功能费用（可选功能）

DynamoDB 还提供一些可选功能，这些功能通常会产生额外费用，包括但不限于：

- **全局二级索引（GSI）**：
  - 如果您为表定义了全局二级索引，您将为这些索引的存储和读写操作支付额外费用。

- **本地二级索引（LSI）**：
  - 类似于 GSI，使用本地二级索引也会产生成本。

- **备份和恢复**：
  - 数据的备份和恢复功能会产生额外费用，通常是按备份的数据量来计算。

- **DynamoDB Streams**：
  - 启用 DynamoDB Streams 后，您将为流中的每个读取请求支付费用。

- **自动扩展**：
  - 对于启用自动扩展的表，您可能会支付与自动扩展相关的管理成本。

### 4. 费用示例

假设：
- 存储 50 GB 数据，每 GB 每月收费 $0.25。
- 读取容量为 20 RCU，写入容量为 10 WCU。
- 每日读取请求 10 万次，写入请求 5 万次（按需计费）。

费用计算：

1. 存储费用：
  - 50 GB x $0.25 = $12.5/月

2. 读取费用（假设按需计费，简单计算）：
  - 每次读取 1 KB = 1 RCU
  - 10 万次读取请求 = 100,000 RCU x $0.0065（假设每 RCU 收费）= $650.00

3. 写入费用（假设按需计费，简单计算）：
  - 每次写入 1 KB = 1 WCU
  - 5 万次写入请求 = 50,000 WCU x $0.0125（假设每 WCU 收费）= $625.00

### 5. 总结

在 DynamoDB 中，费用主要基于存储量、读取和写入操作的数量，以及您可能启用的任何可选功能（如索引、备份等）。为了有效管理成本，建议通过 Amazon CloudWatch 监控使用情况，并定期评估存储和吞吐量设置，以优化费用支出。


# Storage class
Amazon DynamoDB 提供了两种存储类别（Storage Class），以满足不同使用场景和成本要求。这两种存储类别是：

### 1. 标准存储（Standard Storage）

- **定义**：
  - 标准存储是 DynamoDB 的默认存储类别，适用于需要高可用性和低延迟的数据访问场景。它为您提供了快速、可扩展的数据库，适合大多数应用程序。

- **特点**：
  - **高可用性**：标准存储通过自动复制数据到多个可用区（Availability Zones），提供高可用性和持久性。
  - **低延迟**：标准存储优化了读写性能，可以满足低延迟的访问需求，适合需要实时响应的应用。
  - **灵活的吞吐量**：支持按需和预留容量模式，允许用户根据需要配置读取和写入能力。

- **适用场景**：
  - 应用广泛，特别适合在线事务处理（OLTP）、实时分析、高流量网站以及其他需要快速响应的应用。

### 2. 冷存储（On-Demand Backup / Archive Storage）

- **定义**：
  - 冷存储是 DynamoDB 的一种备份和归档选项，适用于不经常访问的数据。通过使用此类存储，您可以将不再主动使用但仍需要保留的数据以更低的成本存储。

- **特点**：
  - **成本效益**：冷存储相比标准存储的费用更低，非常适合长期数据保留和归档需求。
  - **访问频率低**：适用于那些不频繁访问但需要保留的历史数据或长期记录。

- **适用场景**：
  - 数据存档，合规性要求，历史数据保留。

### 选择适合的存储类别

选择标准存储还是冷存储取决于您的应用需求和数据访问模式。以下是一些考虑因素：

- **访问频率**：
  - 如果需要频繁访问和实时处理数据，则选择标准存储比较合适。
  - 如果数据访问频率较低，且主要用于存档或合规用途，则使用冷存储更具成本效益。

- **成本管理**：
  - 通过合理选择存储类别，可以在保证性能的同时降低数据存储成本。

- **数据生命周期管理**：
  - 使用数据生命周期管理策略，确保不再活跃的数据可以迁移到冷存储，从而优化存储和成本。


# RRU (Read Request Unit) & WRU (Write Request Unit)
在 Amazon DynamoDB 中，读取请求单位（Read Request Unit，RRU）和写入请求单位（Write Request Unit，WRU）是衡量表格的读取和写入吞吐量的基本计量单位。理解这些单位对于合理配置和管理 DynamoDB 的性能和成本至关重要。以下是对 RRU 和 WRU 的详细说明：

### 1. 读取请求单位（RRU）

#### a. 定义

- **RRU** 是指进行读取操作时所消耗的单位。当您从 DynamoDB 表中读取数据时，系统会根据读取的数据大小计算所需的 RRU。

#### b. 读取类型

- **强一致性读取**：
  - 每个 RRU 支持每秒读取 4 KB 的数据。
  - 强一致性读取确保读取的数据是最新的，包括所有未被提交的写入。

- **最终一致性读取**：
  - 每个 RRU 可以支持每秒读取 8 KB 的数据。
  - 最终一致性读取可能会返回未同步的数据，但最终会达成一致。

#### c. 示例

- **强一致性读取**：
  - 如果您读取了一个大小为 4 KB 的项目，则消耗 1 RRU。
  - 如果您读取了一个大小为 7 KB 的项目，则消耗 2 RRU（ 向上取整 7/4）。

- **最终一致性读取**：
  - 如果您读取了一个大小为 4 KB 的项目，则消耗 0.5 RRU（因为最终一致性读取每 2 KB 仅消耗 1 RRU）。
  - 如果您读取了一个大小为 9 KB 的项目，则消耗 1.5 RRU（12 KB/8 KB = 1.5，）。

### 2. 写入请求单位（WRU）

#### a. 定义

- **WRU** 是指进行写入操作时所消耗的单位。当您往 DynamoDB 表中写入或更新数据时，系统会根据写入的数据大小计算所需的 WRU。

#### b. 写入方式

- 每个 WRU 支持每秒写入 1 KB 的数据。
- 写入 时，每次写入都按实际写入数据的大小计算 WRU。

#### c. 示例

- 如果您写入了一个大小为 1 KB 的项目，则消耗 1 WRU。
- 如果您写入一个大小为 5 KB 的项目，则消耗 5 WRU，因为每 1 KB 计算 1 WRU。

### 3. 管理和优化 RRU 和 WRU

#### a. 监控和分析

- 使用 Amazon CloudWatch 查看 RRU 和 WRU 的使用情况，以确保它们在承载的范围内。
- 监控请求的利用率和吞吐量，以便在需要时调整读写容量。

#### b. 调整容量

- **预留容量模式**：
  - 指定表的 RRU 和 WRU，DynamoDB 会基于这些设置动态管理分区。

- **按需模式**：
  - DynamoDB 根据请求的需要自动调整 RRU 和 WRU，适合流量波动较大的应用。

#### c. 数据模型优化

- 通过合理设计主键和二级索引，减少不必要的读取和写入请求。
- 使用批量操作，尽量减少单次请求的数量，提升吞吐量。

### 4. 成本评估

- 核算 RRU 和 WRU 的费用时，需考虑您选择的容量模式。
- 按照所消耗的 RRU 和 WRU 与其相应的费用标准计算出每月支出，确保在预算之内。

# RCU (Read Capacity Unit) & Write Capacity Unit (WCU)

## RCU (Read Capacity Unit)
- measure the read throughput
- maximum number of RRU that can be consumed per second
- 

## Write Capacity Unit (WCU)
- measure the write throughput
- maximum number of WRU that can be consumed per second

## partition throughput capacity
[在 DynamoDB 中设计并有效使用分区键的最佳实践](https://docs.aws.amazon.com/zh_cn/amazondynamodb/latest/developerguide/bp-partition-key-design.html)

### 1. 分区的吞吐量限制

DynamoDB 对每个分区的读写能力有明确的限制：

#### a. 读取能力限制（RCU）
- MAX read calls/sec

- **每个分区每秒的强一致性读取限制**：
  - 每个分区最多可以处理 **3,000 RCU** 的强一致性读取。例如，如果您试图进行超过 3,000 RCU 的强一致性读取，您可能会收到“请求被限制”错误。

- **每个分区每秒的最终一致性读取限制**：
  - 每个分区最多可以处理 **6,000 RCU** 的最终一致性读取，这意味着它能够以每秒 8 KB 的效率处理从 DynamoDB 表中的数据读取。

#### b. 写入能力限制（WCU）
- max write calls/sec
- **每个分区每秒的写能力限制**：
  - 每个分区最多可以处理 **1,000 WCU** 的写入操作。这表示您每秒可以写入 1,000 个项目，大小为 1 KB 的数据。如果写入数据的大小超过 1 KB，则会消耗相应数量的 WCU。

### 2. 分区的自动扩展

- **自动扩展**：
  - DynamoDB 可以根据负载自动创建分区。当您达到分区吞吐量的限制时，DynamoDB 会根据需要动态增加新的分区以处理额外的请求。

- **数据分布**：
  - 设计良好的主键可以确保数据均匀分布在多个分区之间，从而提高吞吐量和性能。如果所有数据集中在少数几个分区，则这些分区可能会达到吞吐量限制，从而导致性能瓶颈。


## tables throughput capacity

### maximum availability io capacity depends on number of partitions
比如你有四个分区，那么你的表的最大吞吐量就是：
强一致RCU：4 * 3000 = 12000
最终一致RCU：4 * 3000 * 2 = 24000
WCU：4 * 1000 = 4000
