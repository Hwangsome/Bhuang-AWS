# Amazon EC2 Basics
## EC2
### **Amazon EC2 简介**

Amazon EC2（Elastic Compute Cloud，弹性计算云）是AWS最受欢迎的服务之一，属于**基础设施即服务（IaaS）**的类别。通过EC2，用户可以灵活地使用和管理计算资源，以下是它的主要功能：

1. **租用虚拟机（EC2 实例）**：
    - EC2 允许用户根据需求租用虚拟机，用户可以选择不同的配置来满足计算、存储和网络的需求。

2. **在虚拟驱动器上存储数据（EBS）**：
    - EC2 提供弹性块存储（EBS），作为虚拟机的持久存储解决方案，用户可以将数据存储在EBS中，并根据需求扩展存储容量。

3. **跨多台机器分发负载（ELB）**：
    - 通过弹性负载均衡器（ELB），用户可以将流量分布到多台EC2实例上，确保高可用性并分散流量负载。

4. **使用自动扩展组（ASG）进行服务扩展**：
    - 自动扩展组（ASG）可以根据流量需求自动调整EC2实例的数量，确保在负载增加时自动扩展实例，负载降低时自动缩减实例，保证成本优化。

### **总结**
了解EC2对理解云计算的工作原理至关重要。它提供了灵活的计算资源，通过虚拟机、存储、负载均衡和自动扩展等功能，帮助用户在云端构建高效、可扩展的应用程序和服务。

## EC2 sizing & configuration options 
### **EC2实例的配置和大小选择**

在使用Amazon EC2时，用户可以根据特定需求调整实例的配置和大小，以优化性能、成本和适应不同的工作负载。以下是配置EC2实例时的主要选项：

### 1. **操作系统 (OS)**

- **可选系统**：
    - **Linux**：支持多种发行版，如Amazon Linux、Ubuntu、CentOS等，适用于开源应用程序和开发环境。
    - **Windows**：提供Windows Server，适用于运行Windows特有的应用程序或使用.NET、Windows SQL等技术栈的环境。
    - **Mac OS**：适用于开发和构建Apple平台应用程序，特别是在CI/CD工作流中使用。

### 2. **计算能力与核心数 (CPU)**

- **计算能力**：用户可以根据计算需求选择不同的虚拟CPU（vCPU）数量，决定实例的计算能力。
    - **适合场景**：计算密集型任务（如数据处理、机器学习）、普通应用程序等，用户可以选择从1到数十个vCPU的实例。
    - **实例类型**：AWS提供不同系列的实例类型（如T系列、M系列、C系列等），用于适应不同的工作负载。

### 3. **内存 (RAM)**

- **随机访问内存 (RAM)**：内存的大小决定了应用程序的内存使用能力，影响实例的性能。
    - **选择内存大小**：根据应用程序的需求，可以选择从几GB到几TB不等的内存。大内存实例适用于内存密集型任务，如高性能数据库、内存缓存等。

### 4. **存储空间**

EC2 提供多种存储选项，用户可以根据数据持久性和性能需求选择合适的存储方式：

- **网络连接的存储**：
    - **EBS（Elastic Block Store）**：持久性存储，可以随时附加到EC2实例上，支持快照、备份等功能。适合需要长期存储数据的应用。
    - **EFS（Elastic File System）**：分布式文件系统，可以跨多个实例共享，适合存储需要多台实例同时访问的数据。

- **实例存储（EC2 Instance Store）**：
    - **硬件存储**：本地存储，直接挂载在EC2实例上，提供极低的延迟和高性能，但数据在实例停止或终止时会丢失，适合临时存储数据。

### 5. **网络配置**

- **网卡速度**：可以选择不同速度的网络接口卡（NIC），适应不同的网络带宽需求。高速网卡适用于高吞吐量或网络密集型应用。

- **公有IP地址**：实例启动时可以配置公有IP地址，用于与外部网络交互，特别是需要公开访问的应用程序。

### 6. **防火墙规则 (Security Group)**

- **安全组**：安全组充当虚拟防火墙，控制进出实例的流量。用户可以定义允许的端口、IP范围和协议类型。
    - **入站规则**：控制哪些流量可以进入EC2实例。
    - **出站规则**：控制哪些流量可以从EC2实例发送出去。

### 7. **引导脚本 (Bootstrap Script)**

- **EC2用户数据（EC2 User Data）**：用户可以在实例首次启动时执行一个**引导脚本**。该脚本可以自动配置实例，安装软件、配置服务、下载应用程序等。
    - **用途**：通过用户数据脚本，可以在实例启动时完成初始设置和自动化配置，减少手动操作。

### **总结**

配置EC2实例时，用户需要根据操作系统、计算能力、内存、存储、网络、安全性等多个因素进行选择。这些配置可以优化实例的性能并确保满足应用程序的需求。此外，通过引导脚本（EC2 User Data），可以在实例启动时自动完成必要的配置和初始化工作，从而实现更高效的实例管理。


## EC2 User Data
### 启动EC2 的时候可以设置EC2 User Data 脚本
这个脚本可以是去下载一些资源
![img_10.png](img%2Fimg_10.png)
### **EC2 User Data 详解**

**EC2 User Data** 是AWS EC2实例启动时运行的脚本，用于自动执行各种启动任务，这个过程称为**引导（bootstrapping）**。它可以帮助用户在实例首次启动时自动完成一些初始化配置和操作，避免手动操作，提高工作效率。

### **主要特点**

1. **引导实例（bootstrapping）**：
    - **引导**是指在实例启动时执行预定义的命令或脚本。通过使用EC2 User Data，用户可以在实例首次启动时自动执行一系列任务，如安装软件、配置服务等。
    - **运行时机**：EC2 User Data脚本会在实例**首次启动时运行**，并且只运行一次。如果实例停止后重新启动，该脚本不会再次执行。

2. **自动化启动任务**：
    - **EC2 User Data** 脚本可以用来自动化各种任务，包括：
        - **安装操作系统更新**：例如自动安装最新的安全补丁和软件包。
        - **安装必要软件**：如Nginx、Apache、MySQL、Docker等应用程序。
        - **从互联网下载文件**：可以自动下载配置文件、脚本或代码库。
        - **执行任意命令**：任何可以在终端执行的命令都可以放入User Data脚本中运行。

3. **以root用户权限运行**：
    - EC2 User Data脚本是以**root用户**的权限运行的，这意味着脚本中的所有命令都具有最高权限，可以对系统进行任意更改和配置。这为配置实例提供了极大的灵活性。

### **常见使用场景**

1. **自动安装软件和配置服务**：
    - 用户可以在实例启动时自动安装所需的软件包，例如安装Apache Web服务器、MySQL数据库，或者启动某些系统服务。这对于快速部署和初始化开发环境或生产环境非常有用。

   **示例脚本**：
   ```bash
   #!/bin/bash
   yum update -y
   yum install -y httpd
   systemctl start httpd
   systemctl enable httpd
   ```

   这个脚本会在实例启动时：
    - 更新系统软件包。
    - 安装Apache HTTP服务器。
    - 启动Apache服务并将其配置为开机自动启动。

2. **配置应用程序环境**：
    - EC2 User Data还可以用于自动配置应用程序环境，例如设置环境变量、下载应用程序代码或配置文件等。这样，可以大大减少实例启动后的手动配置工作。

3. **自动化集群管理**：
    - 在需要多个实例一起工作（例如集群或负载均衡环境）时，用户可以通过User Data脚本自动将新实例加入到集群中，或者配置必要的网络和存储设置。

### **如何使用EC2 User Data**

1. **在启动实例时设置**：
    - 当你通过AWS管理控制台、CLI或SDK启动EC2实例时，可以在“高级详细信息”部分输入User Data脚本。
    - 可以是简单的Shell脚本（用于Linux实例）或PowerShell脚本（用于Windows实例）。

2. **脚本格式**：
    - 对于Linux实例，User Data通常是一个**Shell脚本**（以`#!/bin/bash`开头）。
    - 对于Windows实例，User Data可以是**PowerShell脚本**。

3. **运行方式**：
    - EC2 User Data脚本会在实例**首次启动**时自动执行，并且运行后不会再次自动执行。你可以通过停止和重新启动实例手动触发脚本的执行，但默认情况下脚本只运行一次。

### **注意事项**

- **只运行一次**：EC2 User Data默认只在实例首次启动时运行，如果需要再次运行脚本，你可以通过重启实例或手动修改脚本内容并重启。
- **脚本长度限制**：EC2 User Data的脚本长度最大为16KB。如果脚本过长，可以考虑将脚本拆分或者将部分任务外部化（例如通过脚本下载远程文件）。
- **脚本调试**：如果脚本没有按预期执行，可以查看实例的日志文件（通常位于`/var/log/cloud-init-output.log`）来检查错误和输出。

### **总结**

EC2 User Data 是AWS EC2实例提供的一个强大的自动化工具，用于在实例启动时执行各种初始化任务。通过User Data，用户可以自动化操作系统的更新、软件安装、文件下载和系统配置，极大提高了实例配置的效率。它不仅减少了手动操作的繁琐步骤，还确保了实例启动后的环境一致性。

## EC2 Instance Types - Overview （todo）


## Introduction to Security Groups
![img_11.png](img%2Fimg_11.png)
### **AWS Security Group 详解**

**Security Group（安全组）** 是AWS中的一种虚拟防火墙，用于控制进出EC2实例的网络流量。它是AWS安全管理的重要组成部分，帮助用户保护其实例免受未授权的访问。安全组通过配置入站和出站规则，来允许或拒绝特定类型的网络流量。

### Security Groups Diagram
![img_12.png](img%2Fimg_12.png)
你配置了的Inbound rule 限制了哪个IP（网段） 哪个Port可以访问你的EC2， 如果不是这个，security group将会把这个流量拦截下来，不会到达EC2。
但是你的EC2 却默认可以访问外界的任何IP 任何 Port

### **Security Group 的主要特点**

1. **虚拟防火墙**：
    - Security Group 是针对**实例级别**的虚拟防火墙，作用于EC2实例，控制允许哪些流量进出实例。
    - 每个EC2实例都可以关联一个或多个安全组，安全组中的规则决定了实例的访问权限。

2. **无状态与有状态 【这一点很重要】**：
    - **有状态（Stateful）**：Security Group是有状态的，这意味着如果允许入站流量，则响应的出站流量自动允许。反之亦然，不需要为出站流量单独创建规则。

3. **入站规则与出站规则**：
    - **入站规则（Inbound Rules）**：定义允许哪些流量进入EC2实例。你可以根据IP地址范围（CIDR）、协议类型（TCP、UDP、ICMP等）和端口号来设置规则。
    - **出站规则（Outbound Rules）**：定义允许哪些流量从EC2实例发送出去。如果未明确允许，所有出站流量默认会被允许。

4. **默认的安全策略 【这一点很重要】**：
    - **默认拒绝所有入站流量**：在创建新的安全组时，默认所有入站流量都被拒绝，用户需要手动配置允许的入站规则。
    - **默认允许所有出站流量**：新创建的安全组会允许所有出站流量，但你也可以通过自定义规则来控制出站流量。

5. **基于规则的流量控制**：
    - 安全组通过定义规则来允许或拒绝流量，每个规则包含：
        - **协议**：如TCP、UDP、ICMP等。
        - **端口号**：如80（HTTP）、443（HTTPS）、22（SSH）等。
        - **源/目标**：流量的来源或目标，可以是IP地址（CIDR范围）或其他安全组。

6. **多个实例共享同一安全组**：
    - 同一个安全组可以关联多个实例，而多个实例共享相同的安全组规则。你不必为每个实例创建单独的安全组，简化了管理。

### **Security Group 的工作机制**

1. **入站流量控制**：
    - 通过入站规则控制哪些流量可以进入EC2实例。例如，如果你想让外部用户通过SSH访问实例，必须为22号端口（SSH）配置允许的入站规则。

2. **出站流量控制**：
    - 通过出站规则控制实例可以向外发送哪些流量。例如，你可以允许实例访问外部HTTP服务器，则需要为80或443端口添加出站规则。

3. **有状态规则**：
    - **有状态性**：当安全组允许一个方向的流量时，响应的流量在相反方向上将自动允许。例如，如果允许了TCP 80端口的入站流量，则该流量的响应出站流量自动被允许，无需额外规则。

### **Security Group 的常见使用场景**

1. **Web服务器**：
    - 允许HTTP（80端口）和HTTPS（443端口）的入站流量，拒绝所有其他入站流量。
    - 允许出站流量访问数据库、缓存或其他内部服务。

   **示例规则**：
    - 入站规则：
        - 允许所有IP地址访问80端口（HTTP）。
        - 允许所有IP地址访问443端口（HTTPS）。
    - 出站规则：
        - 默认允许所有流量。

2. **数据库服务器**：
    - 数据库服务器通常不对外开放，入站流量仅来自特定的Web服务器或应用服务器。

   **示例规则**：
    - 入站规则：
        - 允许来自特定Web服务器的IP或安全组访问3306端口（MySQL）。
    - 出站规则：
        - 默认允许所有流量。

3. **SSH管理访问**：
    - 通过允许SSH端口（22）的入站流量，管理员可以远程访问服务器进行管理操作。

   **示例规则**：
    - 入站规则：
        - 允许来自管理员的静态IP地址访问22端口（SSH）。
    - 出站规则：
        - 默认允许所有流量。

### **Security Group 的使用最佳实践**

1. **最小权限原则**：
    - **只允许必要的流量**：只允许所需的入站和出站流量，避免暴露不必要的端口。遵循最小权限原则，减少潜在的攻击面。

2. **使用安全组控制内部通信**：
    - 在复杂的多层架构中，可以通过安全组来控制各个层之间的内部通信。例如，限制Web服务器只能与应用服务器通信，而应用服务器只能与数据库通信。

3. **安全组命名规范**：
    - 使用清晰的命名规则对安全组进行命名，确保容易理解安全组的用途和作用。例如，命名为“web-server-sg”可以帮助你快速识别它是用于Web服务器的安全组。

4. **定期审查安全组**：
    - 定期检查安全组规则，确保它们符合当前的安全需求，删除不必要或过时的规则。

5. **限制SSH访问**：
    - 对于SSH访问，只允许来自特定IP地址的流量，避免开放全网的SSH访问（`0.0.0.0/0`），这样可以防止未授权的远程登录。

### **如何创建与管理 Security Group**

1. **创建安全组**：
    - 登录AWS管理控制台，选择“EC2”，然后在左侧菜单中点击“Security Groups”。
    - 点击“Create Security Group”，为安全组命名并添加描述。
    - 配置入站和出站规则，指定允许的协议、端口和IP范围。
    - 选择一个VPC（虚拟私有云）进行关联，然后点击“Create”。

2. **管理安全组**：
    - 安全组创建后可以随时修改规则。通过管理控制台、AWS CLI或SDK，你可以添加、删除或修改入站和出站规则。
    - 安全组的更改会立即生效，无需重启实例。

3. **关联安全组到实例**：
    - 当启动新的EC2实例时，可以选择关联现有的安全组，也可以在实例运行时随时更改安全组。
### Security groups rules can reference by IP or by security group

是的，**AWS安全组（Security Group）规则**可以通过以下两种方式进行引用：

#### 1. **通过IP地址引用**
- **定义**：你可以通过指定**IP地址**或**CIDR块**来允许特定的入站或出站流量。
- **使用场景**：这种方式常用于限制来自特定IP范围的访问，或者将实例限制在特定的子网或网络范围内。
- **格式**：
   - 可以使用单个IP地址（如`203.0.113.5/32`）来允许该地址的访问。
   - 可以使用CIDR块（如`203.0.113.0/24`）来允许特定范围的IP访问。

**示例**：
- 允许来自`192.168.0.0/24`子网的所有IP通过80端口（HTTP）访问实例：
  ```text
  Protocol: TCP
  Port Range: 80
  Source: 192.168.0.0/24
  ```

#### 2. **通过安全组引用**
- **定义**：你可以通过引用**另一个安全组**来定义允许的流量，这意味着来自被引用安全组中实例的流量将被允许，而不是具体的IP地址。
- **使用场景**：这种方式常用于允许同一VPC中不同实例之间的安全通信。例如，允许Web服务器与应用服务器之间的通信，或者允许应用服务器与数据库服务器之间的通信。
- **好处**：
   - **动态性**：安全组引用是动态的，不需要固定的IP地址。如果安全组内的实例发生变化（如IP地址更改或扩展实例），安全组引用仍然有效。
   - **跨账户引用**：你也可以跨不同的AWS账户引用安全组，前提是它们位于同一个VPC中。

**示例**：
- 假设有两个安全组，一个用于Web服务器（`web-sg`），另一个用于数据库服务器（`db-sg`）。你可以在数据库服务器的安全组（`db-sg`）中允许来自Web服务器的流量：
  ```text
  Protocol: TCP
  Port Range: 3306 (MySQL)
  Source: web-sg (安全组ID)
  ```

#### **具体使用场景示例**

1. **通过IP地址引用**：
   - **公共访问Web服务器**：允许全网范围的用户通过HTTP访问Web服务器。使用`0.0.0.0/0`（即允许所有IP地址）访问80端口。
     ```text
     Protocol: TCP
     Port Range: 80
     Source: 0.0.0.0/0
     ```

2. **通过安全组引用**：
   - **Web服务器和数据库服务器通信**：假设你的Web服务器安全组`web-sg`和数据库服务器安全组`db-sg`分别用于Web层和数据库层通信。你可以在`db-sg`中允许`web-sg`中的实例通过3306端口访问数据库。
     ```text
     Protocol: TCP
     Port Range: 3306
     Source: web-sg
     ```

#### **总结**

- **通过IP地址引用**：适用于需要精确控制IP范围的场景，如限制某个IP地址或IP段的访问。
- **通过安全组引用**：适用于需要动态控制VPC内实例间通信的场景，特别是在多个EC2实例间进行安全通信时，不依赖于固定IP地址。

这两种引用方式使得安全组的配置非常灵活，能够满足不同的网络安全需求。

### AWS Security Groups: 重要信息
- Security groups 仅仅包含 allow rules， 没有配置的默认是 deny。
- 可以附加到多个实例：
  - 一个安全组可以被关联到多个EC2实例。这意味着你不必为每个实例单独创建安全组，可以复用同一个安全组来管理类似实例的访问规则。
- 受限于特定的区域和VPC组合：
  - 安全组是区域性和VPC相关的，即一个安全组只能在特定的AWS区域和VPC内使用。它不能跨区域或跨VPC使用，必须在创建它的区域和VPC内配置实例。
- 安全组位于EC2实例“外部”：
  - 安全组的工作原理是在流量到达EC2实例之前就进行筛选和过滤。因此，如果流量被安全组阻止，实例根本不会看到这些请求。这是一种有效的保护机制。
- 为SSH访问维护一个独立的安全组：
  - 建议为SSH访问创建一个单独的安全组，用来控制和监控谁可以通过SSH访问你的EC2实例。这有助于提高管理和安全性，比如只允许来自特定IP地址的SSH访问。
- 如果应用程序超时（time out），通常是安全组的问题：
  - 如果你的应用程序无法访问并出现“超时”错误，很可能是安全组阻止了访问。检查安全组的入站规则，确保允许必要的端口（例如，HTTP的80端口或HTTPS的443端口）访问实例
- 如果应用程序显示“连接被拒绝”（connection refused），通常是应用程序错误或未启动：
  - 如果出现“连接被拒绝”错误，这通常意味着应用程序本身存在问题，例如应用程序没有启动或监听指定的端口，或者服务配置错误。此时应该检查应用程序日志或服务状态。
- 所有入站流量默认被阻止：
  - 新创建的安全组默认阻止所有入站流量，需要手动添加允许的入站规则来打开特定端口以供访问。
- 所有出站流量默认被允许：
  - 安全组默认允许所有出站流量，这意味着实例可以与外部互联网或其他服务自由通信，除非你手动设置出站规则进行限制。
- 如果遇到网络连接问题，首先检查安全组的入站规则，确保正确配置了所需的端口和IP范围。

### **总结**

AWS Security Group 是一种强大且灵活的安全机制，充当虚拟防火墙，用于控制EC2实例的网络流量。它通过配置入站和出站规则，确保实例只接受和发送允许的流量，从而保护实例不受未授权的访问。遵循最小权限原则、命名规范和定期审查安全组，可以帮助用户有效管理云上资源的安全性。