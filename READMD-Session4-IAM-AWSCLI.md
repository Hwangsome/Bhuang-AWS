# IAM & AWS CLI

## IAM Introduction: Users, Groups, Policies

### IAM: Users & Groups
![img_2.png](img%2Fimg_2.png)
AWS身份和访问管理（IAM，Identity and Access Management）是一项非常重要的服务，它可以让你安全地管理对AWS服务和资源的访问。通过IAM，你可以控制谁可以访问AWS资源（用户和角色），他们可以对这些资源做什么（权限），以及他们何时可以进行访问。IAM的基本概念和组件的详细介绍：

#### 1. **IAM用户（IAM Users）**
- **定义**：IAM用户代表一个在AWS中可以操作资源的实体。它通常代表一个特定的人（例如开发人员、管理员）或者一个应用程序。
- **特点**：
    - 每个IAM用户在创建时都会获得一个唯一的身份（用户名）。
    - IAM用户可以拥有用于控制台访问的登录凭据（用户名和密码），也可以拥有用于编程访问AWS API、CLI或SDK的访问密钥（Access Keys）。
    - 每个用户只能属于一个AWS账户。
    - 用户可以根据分配的权限执行特定的操作（例如启动EC2实例、访问S3存储桶等）。
- **常见用例**：
    - 为每个开发人员或管理员创建单独的IAM用户，确保可以针对个人设置权限并跟踪他们的操作。
    - 为应用程序创建IAM用户，以便它们可以安全地与AWS资源进行交互。

#### 2. **IAM组（IAM Groups）**
- **定义**：IAM组是一个用户集合，你可以将多个用户放入一个组中并应用相同的权限。通过IAM组，你可以更方便地管理用户的权限。
- **特点**：
    - 组本身没有凭据，组只是权限的容器。
    - 你可以为一个IAM组分配多个策略（Policies），这些策略将适用于该组中的所有用户。
    - 一个用户可以同时属于多个IAM组，从而获得不同组的权限。
- **常见用例**：
    - 为开发团队创建一个开发者组，并赋予该组所有开发环境的访问权限。
    - 为系统管理员创建一个管理员组，赋予其完全控制权限。

#### 3. **IAM策略（IAM Policies）**
![img_3.png](img%2Fimg_3.png)
- **定义**：IAM策略是权限的定义，它是一个JSON文档，用于指定允许或拒绝的操作。策略可以分配给用户、组或角色，用于控制这些实体可以执行的具体操作。
- **策略类型**：
    1. **托管策略（Managed Policies）**：
        - **AWS托管策略**：这些是由AWS预定义和维护的策略，适用于常见的使用场景。你可以直接附加给用户、组或角色，简化权限管理。
        - **客户托管策略**：你可以创建自定义策略并将其附加给用户、组或角色，根据你的具体需求精细控制权限。
    2. **内联策略（Inline Policies）**：这些策略直接嵌入到用户、组或角色中，通常用于限制性或临时性的权限分配。

- **策略结构**：
    - **版本（Version）**：指定策略语法版本，通常使用`"Version": "2012-10-17"`。
    - **声明（Statement）**：定义具体的权限，包括：
        - **动作（Action）**：描述允许或拒绝执行的AWS服务操作。例如，`"s3:ListBucket"`允许用户列出S3存储桶中的对象。
        - **资源（Resource）**：指定动作应用的AWS资源。例如，可以是特定的S3存储桶或EC2实例。
        - **效果（Effect）**：指定允许（Allow）或拒绝（Deny）某个操作。
        - **条件（Condition）**：可以通过条件进一步限制策略，例如基于时间或源IP的访问控制。

- **常见用例**：
    - 创建策略以允许用户只对特定的S3存储桶具有只读访问权限。
    - 为组创建策略，以确保开发者只能访问开发环境资源，而不能访问生产环境。

##### IAM Policies inheritance
![img_4.png](img%2Fimg_4.png)

##### IAM Policies Structure

IAM策略是用来定义对AWS资源的权限的JSON文档。每个策略描述了允许或拒绝的操作、应用的资源以及相关的条件。以下是IAM策略的详细结构：

###### 1. **Version**
- **定义**：表示策略语言的版本号，通常用于确保向后兼容性。AWS建议始终使用`"Version": "2012-10-17"`，这是最新的策略语法版本。
- **作用**：虽然不直接影响权限，但必须包含这一字段以确保策略的有效性。

   ```json
   "Version": "2012-10-17"
   ```

###### 2. **Id**
- **定义**：策略的标识符，用于唯一标识策略（可选）。
- **作用**：主要用于在多个策略中区分或标识特定策略。

   ```json
   "Id": "ExamplePolicyID12345"
   ```

###### 3. **Statement**
- **定义**：每个策略至少包含一个`Statement`，可以包含多个语句。`Statement`是策略的核心部分，定义了具体的权限规则。
- **结构**：每个`Statement`字段包含多个子字段，定义了策略的作用、允许或拒绝的操作、资源等。

   ```json
   "Statement": [
       {
           "Sid": "1",
           "Effect": "Allow",
           "Action": "s3:ListBucket",
           "Resource": "arn:aws:s3:::example-bucket"
       }
   ]
   ```

###### 4. **Statement 子字段**
- **Sid（可选）**：
    - **定义**：`Sid`是语句的唯一标识符（Statement Identifier），用于标识特定的语句（可选）。
    - **作用**：如果一个策略中有多个语句，`Sid`有助于区分每个语句。

  ```json
  "Sid": "AllowS3ListBucket"
  ```

- **Effect（必需）**：
    - **定义**：`Effect`用于指明该语句是**允许（Allow）**还是**拒绝（Deny）**某些操作。每个语句必须明确声明是允许还是拒绝。
    - **作用**：`Allow`表示允许执行指定的操作，`Deny`表示拒绝指定操作。默认情况下，如果没有明确允许，所有操作都被拒绝。

  ```json
  "Effect": "Allow"
  ```

- **Principal（主要针对资源策略，非必需）**：
    - **定义**：`Principal`指定策略应用的账户、用户或角色。它通常用于资源策略，指定谁可以访问该资源。
    - **作用**：通过`Principal`可以定义策略的主体，即允许或拒绝访问AWS资源的实体（例如用户、角色、服务等）。

  ```json
  "Principal": {
      "AWS": "arn:aws:iam::123456789012:user/ExampleUser"
  }
  ```

- **Action（必需）**：
    - **定义**：`Action`字段列出了策略允许或拒绝的具体AWS服务操作（API调用）。例如，`s3:ListBucket`是允许列出S3存储桶的操作。
    - **作用**：通过`Action`定义用户或角色可以执行的具体操作。可以是一个操作，也可以是多个操作，使用通配符（`*`）表示所有操作。

  ```json
  "Action": "s3:ListBucket"
  ```

- **Resource（必需）**：
    - **定义**：`Resource`指定策略作用的AWS资源。例如，特定的S3存储桶、EC2实例或DynamoDB表等资源。资源的ARN（Amazon Resource Name）用于唯一标识AWS资源。
    - **作用**：通过`Resource`来控制操作可以应用于哪些具体资源。也可以使用通配符（`*`）来指定所有资源。

  ```json
  "Resource": "arn:aws:s3:::example-bucket"
  ```

- **Condition（可选）**：
    - **定义**：`Condition`定义策略生效的具体条件。可以根据时间、IP地址、身份验证方式等限制策略的生效。
    - **作用**：`Condition`允许基于特定条件来进一步限制策略的应用。例如，你可以定义策略仅在特定时间段或从特定IP地址时生效。

  ```json
  "Condition": {
      "IpAddress": {
          "aws:SourceIp": "192.0.2.0/24"
      }
  }
  ```

###### IAM策略示例

以下是一个完整的IAM策略示例，允许用户列出特定S3存储桶中的对象，但仅在从特定IP地址访问时生效：

```json
{
   "Version": "2012-10-17",
   "Id": "PolicyExample1",
   "Statement": [
       {
           "Sid": "AllowS3ListBucket",
           "Effect": "Allow",
           "Action": "s3:ListBucket",
           "Resource": "arn:aws:s3:::example-bucket",
           "Condition": {
               "IpAddress": {
                   "aws:SourceIp": "192.0.2.0/24"
               }
           }
       }
   ]
}
```

###### 总结
IAM策略通过定义操作（Action）、资源（Resource）和条件（Condition）来控制AWS资源的访问权限。每个策略至少有一个语句（Statement），其中明确了是允许（Allow）还是拒绝（Deny）某些操作。策略的灵活性使得你可以精细控制谁可以访问什么资源以及在什么条件下可以访问，从而保证了AWS环境的安全性和合规性。

#### 4. **IAM角色（IAM Roles）**
- **定义**：IAM角色是一种身份，可以临时为其他实体（如AWS服务、应用程序或外部用户）授予权限，而无需为它们创建IAM用户或密钥。
- **特点**：
    - 角色和用户的主要区别在于，角色没有长期的凭据（如密码或访问密钥）。相反，角色提供临时凭证，并且可以由AWS服务（如EC2实例）或其他身份使用。
    - 角色可以授予AWS服务、AWS账户中的用户或第三方账户中的用户临时访问权限。
- **常见用例**：
    - 为EC2实例分配角色，使实例可以直接访问S3或其他AWS服务，而无需嵌入访问密钥。
    - 为跨账户访问设置角色，允许一个AWS账户中的用户访问另一个AWS账户的资源。

#### 5. **IAM最佳实践**
- **最小权限原则**：授予每个用户或组执行其工作所需的最低权限。避免为用户授予不必要的全局权限。
- **使用组来管理用户权限**：通过将用户添加到组并将权限分配给组，简化权限管理。
- **启用多重身份验证（MFA）**：对重要账户启用MFA，以增强账户的安全性。
- **使用IAM角色**：尽量使用IAM角色来管理AWS服务之间的权限授予，减少使用长期凭证的需求。
- **定期审查权限**：定期审查用户和角色的权限，确保符合安全要求并删除不再需要的权限。

#### 总结
AWS IAM是管理AWS资源访问的核心服务。通过合理配置IAM用户、组、策略和角色，你可以精细控制谁可以访问哪些资源以及他们能够执行的操作。IAM提供了强大的安全和访问控制机制，确保你的AWS环境既能满足业务需求，也能保持最高的安全标准。

## AWS Access Keys, CLI and SDK
要访问AWS，用户有三种主要方式，每种方式都有不同的安全机制和使用场景：
获取或者Access key的步骤：
![img_5.png](img%2Fimg_5.png)
### 1. **AWS管理控制台**
- **概述**：AWS管理控制台是一个基于网页的图形界面，用户可以通过它管理AWS资源和服务。
- **保护措施**：
    - **用户名和密码**：IAM用户需要使用其登录凭证（用户名和密码）访问控制台。
    - **多重身份验证（MFA）**：可以启用MFA来增加额外的安全保护，通过移动应用或硬件设备生成一次性验证码。
- **适用场景**：适合管理员或偏好图形界面的用户进行资源管理操作。

### 2. **AWS命令行界面（CLI）**
- **概述**：AWS CLI是一个允许用户通过命令行与AWS服务交互的工具，支持几乎所有的AWS服务并可用于自动化任务。
- **保护措施**：
    - **访问密钥（Access Keys）**：CLI通过访问密钥ID和秘密访问密钥进行身份验证，这些密钥可以在AWS控制台中生成。
- **适用场景**：适合开发人员、系统管理员或DevOps人员通过脚本或命令行自动化管理AWS资源。

### 3. **AWS软件开发工具包（SDK）**
- **概述**：AWS SDK为开发人员提供了通过编程语言（如Python、Java、JavaScript等）与AWS服务交互的工具。
- **保护措施**：
    - **访问密钥（Access Keys）**：与CLI类似，SDK使用访问密钥ID和秘密访问密钥来认证API请求。
- **适用场景**：适合开发人员在应用程序中集成AWS服务，进行资源管理或执行自动化操作。

### **访问密钥管理**
- **生成访问密钥**：访问密钥通过AWS管理控制台生成，用户可以拥有最多两对密钥以便轮换使用。
- **管理访问密钥**：用户需要自己管理访问密钥，包括定期轮换、妥善保存，并确保其不被共享或泄露。

### **理解访问密钥**
- **访问密钥ID**：类似于用户名，用于标识进行API或CLI请求的用户。
- **秘密访问密钥**：类似于密码，用于认证请求，必须保持私密，防止泄露。

### **总结**
- **AWS管理控制台**：提供网页界面访问AWS资源，受用户名、密码和MFA保护。
- **AWS CLI**：通过命令行管理AWS服务，受访问密钥保护。
- **AWS SDK**：通过编程语言与AWS服务交互，同样受访问密钥保护。
- **访问密钥**：像密码一样敏感，必须妥善保管并避免共享，以确保AWS环境的安全。

## What’s the AWS CLI?
### **AWS CLI (Command Line Interface)**

#### **概述**
AWS CLI 是一个允许用户通过命令行与AWS服务交互的工具。它可以让用户直接访问AWS服务的**公共API**，从而实现自动化和脚本化的资源管理。

#### **功能特点**
1. **与AWS服务交互**：
    - AWS CLI提供了一套命令，用户可以通过命令行操作几乎所有的AWS服务（如EC2、S3、RDS等）。
    - 与AWS的**公共API**直接交互，意味着通过CLI执行的命令与通过AWS管理控制台操作具有相同的效果。

2. **脚本开发**：
    - 你可以编写脚本来自动化管理AWS资源。例如，自动化启动或停止EC2实例、备份S3存储桶等任务。
    - 适用于批量操作和重复性任务的自动化处理，提升效率。

3. **开源工具**：
    - AWS CLI 是一个**开源项目**，其源代码托管在GitHub上：[AWS CLI GitHub](https://github.com/aws/aws-cli)。
    - 用户可以通过贡献或查看源代码来参与开发，也可以根据需要进行定制。

4. **AWS管理控制台的替代方案**：
    - AWS CLI是AWS管理控制台的命令行替代方案，特别适合那些需要通过终端快速执行操作或需要将AWS管理集成到自动化系统中的用户。
    - 对于偏好命令行的用户，CLI提供了比图形界面更灵活和强大的操作方式。

#### **用例**
- **自动化任务**：编写脚本在特定时间启动和停止EC2实例，减少人工干预。
- **批量操作**：使用CLI同时处理多个AWS资源，例如一次性上传多个文件到S3或创建多个VPC。
- **持续集成/持续交付（CI/CD）**：在CI/CD流水线中集成AWS CLI来管理基础设施和部署应用。

#### **总结**
AWS CLI是一个功能强大、灵活的命令行工具，通过命令行提供了与AWS服务的直接交互方式。它既适合日常的资源管理，也适用于自动化脚本开发，是AWS管理控制台的高效替代方案。

## What’s the AWS SDK?
### **AWS SDK (Software Development Kit)**

#### **概述**
AWS SDK 是一组语言特定的API库，允许开发人员通过编程方式访问和管理AWS服务。它提供了一种简化的方式，使应用程序可以直接与AWS资源交互，无需开发者自己处理底层的API调用。

#### **主要特点**
1. **语言特定的API库**：
    - AWS SDK 提供了专门针对不同编程语言的API库，帮助开发人员用熟悉的语言构建应用程序并与AWS服务交互。
    - 常见的SDK包括**JavaScript、Python、PHP、.NET、Ruby、Java、Go、Node.js**和**C++**等。

2. **编程管理AWS服务**：
    - 通过这些API库，开发人员可以轻松调用AWS服务，比如启动EC2实例、存储文件到S3、与DynamoDB数据库交互等。
    - AWS SDK简化了访问AWS服务的流程，隐藏了底层API的复杂性，开发人员只需调用简化的函数或方法。

3. **嵌入式应用程序集成**：
    - SDK库可以嵌入到你的应用程序中，允许应用程序在运行时动态访问和管理AWS资源。
    - 例如，可以在Web应用中使用AWS SDK上传用户文件到S3，或者使用Lambda触发函数来处理事件。

4. **支持多种开发平台**：
    - **标准SDK**：适用于各种服务器端语言，如JavaScript、Python、Java等。
    - **移动SDK**：为移动应用提供的SDK，支持**Android**和**iOS**平台，允许开发者将AWS服务集成到移动应用中。
    - **IoT设备SDK**：为物联网（IoT）设备提供的SDK，支持**嵌入式C**和**Arduino**，可以让开发人员将AWS服务与硬件设备集成。

5. **AWS CLI 基于 AWS SDK for Python**：
    - AWS命令行接口（CLI）就是使用AWS SDK for Python（也称为Boto3）构建的。CLI的命令实际上是对Python SDK的进一步封装，提供了更简单的命令行操作。

#### **常见支持的SDKs**
- **JavaScript**: 用于Node.js或浏览器环境，支持常用的AWS服务如S3、DynamoDB、EC2等。
- **Python (Boto3)**: 提供对AWS服务的简化访问，适用于编写自动化脚本和数据分析。
- **Java**: 用于企业级应用程序，支持几乎所有的AWS服务。
- **Go、C++**: 针对高性能和系统级应用的开发。

#### **移动和物联网设备支持**
- **移动SDK**：AWS提供了专门的SDK用于开发**Android**和**iOS**应用程序，支持服务如S3、DynamoDB、Lambda等，帮助移动应用快速集成AWS功能。
- **IoT设备SDK**：用于连接物联网设备到AWS IoT Core，支持嵌入式开发环境（如**嵌入式C**、**Arduino**），使硬件设备可以安全地与AWS云进行通信和数据处理。

#### **AWS SDK 示例**
- **Python (Boto3) 示例**：上传文件到S3
   ```python
   import boto3

   s3 = boto3.client('s3')
   s3.upload_file('localfile.txt', 'mybucket', 's3file.txt')
   ```

- **JavaScript (Node.js) 示例**：列出S3存储桶中的文件
   ```javascript
   const AWS = require('aws-sdk');
   const s3 = new AWS.S3();

   s3.listObjects({ Bucket: 'mybucket' }, (err, data) => {
       if (err) console.log(err);
       else console.log(data);
   });
   ```

#### **总结**
- **AWS SDK** 是一组为开发人员提供的语言特定的API库，帮助他们轻松访问和管理AWS服务。
- SDK被广泛应用于各种场景，包括Web应用、移动应用、物联网设备等。
- 通过AWS SDK，开发人员可以更轻松地在应用程序中集成AWS服务，简化复杂的API调用流程，从而快速构建云应用。

## IAM Roles for Services
![img_6.png](img%2Fimg_6.png)
### **AWS IAM角色（IAM Role）简介**

AWS IAM角色是一种允许某个实体（例如用户、AWS服务或应用程序）暂时获取特定权限的身份，通常用于代替IAM用户的长期凭证（如访问密钥）。IAM角色提供了临时安全凭证，避免了长期暴露的安全风险。它们特别适用于AWS服务之间的交互、跨账户访问以及自动化任务。

### **IAM角色的核心概念**

1. **没有长期凭证**：
    - 与IAM用户不同，IAM角色没有用户名、密码或长期访问密钥。相反，角色通过临时凭证来授予权限，这些凭证具有特定的使用期限，并在到期后失效。

2. **可以授予AWS服务或外部用户/应用**：
    - IAM角色可以授予AWS服务（如EC2、Lambda、ECS）权限，让它们访问其他AWS资源。也可以用于跨账户访问，允许其他AWS账户中的用户使用角色权限。

3. **临时安全凭证**：
    - 当实体（如用户、服务或应用）扮演一个角色时，AWS会为其分配一组临时凭证，包括临时访问密钥、秘密访问密钥和安全令牌。这些凭证具有有限的有效期，通常从几分钟到数小时不等。

4. **通过策略授予权限**：
    - IAM角色通过附加的**权限策略**来控制其可以执行的操作。例如，某个角色可以被允许读取S3存储桶中的数据或启动EC2实例。

### **IAM角色的主要使用场景**

#### 1. **为AWS服务授予权限**
- 当AWS服务（如EC2、Lambda、ECS等）需要访问其他AWS资源时，通常会为它们分配IAM角色。例如：
    - **EC2实例角色**：为EC2实例分配一个角色，使它能够访问S3存储桶或DynamoDB表，而不需要在实例中硬编码访问密钥。
    - **Lambda角色**：Lambda函数在运行时需要访问S3、SNS、DynamoDB等资源，可以通过分配角色来实现。

**示例**：
- 为一个EC2实例分配一个IAM角色，使其能够读取S3存储桶中的文件。

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "s3:GetObject",
        "Resource": "arn:aws:s3:::example-bucket/*"
      }
    ]
  }
  ```

#### 2. **跨账户访问**
- 如果你需要访问另一个AWS账户中的资源，可以使用IAM角色来实现跨账户访问。账户A中的用户可以通过扮演账户B中的角色，临时获取账户B的权限。

**示例**：
- 账户A中的用户希望读取账户B中的S3存储桶数据，账户B可以为账户A的用户创建一个IAM角色，并允许其读取特定的S3存储桶。

#### 3. **临时安全凭证**
- IAM角色通常用于在不需要长期凭证的场景中，例如为外部应用程序或用户提供短期访问AWS资源的权限。外部用户可以通过安全令牌服务（STS）获取临时凭证。

**示例**：
- 使用IAM角色为第三方服务提供短期的S3文件上传权限。

#### 4. **为应用程序或用户动态分配权限**
- 你可以通过IAM角色在不同的上下文中为用户或应用程序动态授予权限。例如，在应用程序中，使用STS获取临时角色并根据上下文动态分配权限。

### **IAM角色的组成部分**

#### 1. **信任策略（Trust Policy）**
- **定义**：信任策略定义谁（例如，哪些实体、服务或账户）可以扮演该角色。角色的信任策略通过声明“允许哪些主体扮演此角色”来决定谁可以使用该角色。
- **示例**：允许EC2服务扮演某个角色。

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "Service": "ec2.amazonaws.com"
        },
        "Action": "sts:AssumeRole"
      }
    ]
  }
  ```

#### 2. **权限策略（Permissions Policy）**
- **定义**：权限策略定义角色可以执行哪些操作。角色的权限策略决定了扮演该角色的实体可以访问哪些AWS资源和执行哪些操作。
- **示例**：允许角色读取S3存储桶中的文件。

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "s3:GetObject",
        "Resource": "arn:aws:s3:::example-bucket/*"
      }
    ]
  }
  ```

#### 3. **临时安全凭证**
- 当实体扮演一个角色时，AWS会通过**STS（安全令牌服务）**生成临时凭证，包括：
    - **临时访问密钥ID**：用于标识该角色的临时访问密钥。
    - **临时秘密访问密钥**：用于验证API请求的秘密密钥。
    - **安全令牌**：与临时密钥结合使用，确保请求的合法性。

### **如何创建IAM角色**

1. **登录AWS管理控制台**并进入IAM服务。
2. **选择“Roles”（角色）**，然后点击**“Create Role”（创建角色）**。
3. **选择受信任实体**：
    - 选择AWS服务、其他AWS账户或Web身份提供者（用于外部访问）。
4. **附加权限策略**：选择角色应具有的权限，例如允许访问S3或启动EC2实例。
5. **配置信任策略**：定义谁可以扮演该角色（如允许EC2服务、其他账户等）。
6. **完成创建**：一旦角色创建完毕，它就可以被分配给AWS服务或外部用户使用。

### **IAM角色的最佳实践**

1. **最小权限原则**：
    - 确保IAM角色只分配最低限度的权限，避免授予不必要的访问权限。

2. **使用角色而非长期凭证**：
    - 对于AWS服务（如EC2、Lambda），始终使用IAM角色来访问其他资源，而不是将访问密钥硬编码到代码中。

3. **跨账户角色管理**：
    - 使用跨账户角色时，确保信任策略和权限策略严格控制谁可以访问哪些资源，避免滥用权限。

4. **定期审查角色使用情况**：
    - 定期审查角色的使用情况和权限，确保权限的合理性。

### ec2上attach iam role访问s3的例子

#### create iam role
![img_8.png](img%2Fimg_8.png)
#### attach iam role to ec2
![img_7.png](img%2Fimg_7.png)

#### verify
![img_9.png](img%2Fimg_9.png)

### **总结**
AWS IAM角色通过临时安全凭证提供了一种灵活、安全的方式，允许AWS服务、用户、应用程序在需要时访问AWS资源。角色的主要优势在于避免了长期凭证的安全风险，并且允许更灵活的跨账户访问、服务访问和临时访问控制。通过合理配置信任策略和权限策略，IAM角色可以帮助你安全高效地管理AWS资源的访问权限。